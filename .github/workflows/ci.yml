name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Using a recent LTS version for production stability
        cache: 'npm' # Cache npm dependencies for faster builds

    - name: Install Dependencies
      run: npm ci # Ensures a clean and consistent dependency installation

    - name: Run Biome Linter and Formatter Check
      run: npx biome check --linter --formatter --max-diagnostics 0 . # Checks for linting and formatting errors, fails if any found

    - name: Run Unit Tests with Vitest
      run: npm test # Assuming package.json has "test": "vitest"

    - name: Build Project
      run: npm run build # Creates a production-ready build of the web application

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium # Install only necessary browsers

    - name: Serve Build for E2E Tests
      run: npm run preview &
      env:
        PORT: 3000 # Specify a port for the preview server

    - name: Run E2E Tests with Playwright
      run: npx playwright test # Executes end-to-end tests against the served build
      env:
        PLAYWRIGHT_BASE_URL: http://localhost:3000 # Point Playwright to the local server
